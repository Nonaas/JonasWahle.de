@using JonasWahle.de.UI.Components.Dialogs
@inject ICookieService CookieService
@inject IDialogService DialogService


<MudLayout>
    <MudAppBar Elevation="5" Dense="true" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudSpacer />
    </MudAppBar>
    
    <MudHidden Breakpoint="@Breakpoint.SmAndDown">
        <MudDrawer @bind-Open="@_isDrawerOpen" ClipMode="DrawerClipMode.Always" Breakpoint="@Breakpoint.Md" Elevation="2" Variant="@DrawerVariant.Mini">
            <NavMenu />
        </MudDrawer>
    </MudHidden>
    <MudHidden Breakpoint="@Breakpoint.MdAndUp">
        <MudDrawer @bind-Open="@_isDrawerOpen" ClipMode="DrawerClipMode.Always" Breakpoint="@Breakpoint.Md" Elevation="2" Variant="@DrawerVariant.Temporary">
            <NavMenu />
        </MudDrawer>
    </MudHidden>

    <MudMainContent>
        @ChildContent
    </MudMainContent>

    <MudAppBar Elevation="5" Class="d-flex justify-content-center" Dense="true" Bottom="true" Fixed="true" Color="Color.Primary">
        <MudLink Color="Color.Secondary" OnClick="async () => await RemoveCookieConsentAsync()">Cookie-Einwilligung entfernen</MudLink>
        <MudSpacer />
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudStack Spacing="0">
                <MudText Align="Align.Center">© 2025</MudText>
                <MudText Align="Align.Center">Jonas Wahle</MudText>
            </MudStack>
            <MudSpacer />
        </MudHidden>
        <MudStack Row Spacing="2">
            <MudTooltip Arrow Placement="Placement.Top" Text="LinkedIn">
                <MudIconButton Icon="@Icons.Custom.Brands.LinkedIn" Color="Color.Primary" Variant="Variant.Filled" Href="https://www.linkedin.com/in/jonas-wahle-13b07a24a/" Target="_blank" />
            </MudTooltip>
            <MudTooltip Arrow Placement="Placement.Top" Text="GitHub">
                <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Color="Color.Primary" Variant="Variant.Filled" Href="https://github.com/Nonaas" Target="_blank" />
            </MudTooltip>
            <MudTooltip Arrow Placement="Placement.Top" Text="Kauf mir einen Kaffee 😉">
                <MudIconButton Icon="@Icons.Material.Filled.Coffee" Color="Color.Primary" Variant="Variant.Filled" Href="https://buymeacoffee.com/gamewhale" Target="_blank" />
            </MudTooltip>
        </MudStack>
    </MudAppBar>
</MudLayout>


@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private bool _isDrawerOpen = false;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            string? hasConsent = await CookieService.GetCookieAsync(Constants.CookieKeys.CookieConsent);

            if (string.IsNullOrEmpty(hasConsent?.Trim()))
            {
                await OpenCookieDialogAsync();
            }            
        }
    }

    private Task OpenCookieDialogAsync()
    {
        DialogOptions options = new()
            {
                CloseOnEscapeKey = false,
                BackdropClick = false
            };

        return DialogService.ShowAsync<CookieDialog>(null, options: options);
    }

    private async Task RemoveCookieConsentAsync()
    {
        await CookieService.DeleteCookieAsync(Constants.CookieKeys.CookieConsent);
        await OpenCookieDialogAsync();
    }

    private void ToggleDrawer()
    {
        _isDrawerOpen = !_isDrawerOpen;
    }

}
