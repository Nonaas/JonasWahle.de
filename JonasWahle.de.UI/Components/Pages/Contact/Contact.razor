@page "/kontakt"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Text
@using JonasWahle.de.Domain.Models
@inject NavigationManager NavigationManager
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
<PageTitle>Kontakt</PageTitle>

<MudStack Spacing="4" Class="mb-3">
    <MudStack Spacing="0">
        <MudText Typo="Typo.h4">Kontakt</MudText>
    </MudStack>

    <EditForm Model="@_sendMessageDto" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator />

        <MudTextField Variant="Variant.Outlined" Label="Name" Class="mb-3" HelperText="Namen eingeben" data-bwignore
        @bind-Value="_sendMessageDto.Name" For="@(() => _sendMessageDto.Name)" InputType="InputType.Text" />

        <MudTextField Variant="Variant.Outlined" Label="Email" Class="mb-3" HelperText="Email eingeben" data-bwignore
        @bind-Value="_sendMessageDto.Email" For="@(() => _sendMessageDto.Email)" InputType="InputType.Email" />

        <MudTextField Variant="Variant.Outlined" Label="Nachricht" Class="mb-3" HelperText="Nachricht eingeben" data-bwignore
        @bind-Value="_sendMessageDto.Message" For="@(() => _sendMessageDto.Message)" InputType="InputType.Text" Lines="3" />

        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" 
        Disabled="@_isSubmitting">
            @if (_isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">Senden ...</MudText>
            }
            else
            {
                <MudText>Senden</MudText>
            }
        </MudButton>
    </EditForm>

</MudStack>

@code{
    private SendMessageDto _sendMessageDto = new();
    private bool _isSubmitting = false;


    private async Task OnValidSubmit(EditContext context)
    {
        if (_isSubmitting) return;

        _isSubmitting = true;
        StateHasChanged();

        try
        {
            using HttpClient httpClient = HttpClientFactory.CreateClient();

            var json = JsonSerializer.Serialize(_sendMessageDto);
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            var response = await httpClient.PostAsync($"{NavigationManager.BaseUri}api/contact", content);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Nachricht erfolgreich gesendet!", Severity.Success);
                _sendMessageDto = new();
            }
            else
            {
                Snackbar.Add("Fehler beim Senden der Nachricht. Bitte versuchen Sie es erneut.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ein unerwarteter Fehler ist aufgetreten: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }
}
